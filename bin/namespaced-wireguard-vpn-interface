#!/usr/bin/env bash

die() {
    echo "${BASH_SOURCE[1]}: line ${BASH_LINENO[0]}: ${FUNCNAME[1]}: ${1:-Died}" >&2
    exit 1
}

case "$1" in
    up)
        ip link add "$WIREGUARD_NAME" type wireguard || die

        wg set "$WIREGUARD_NAME" \
            listen-port "$WIREGUARD_LISTEN_PORT"
            private-key <(echo "$WIREGUARD_PRIVATE_KEY") \
            peer "$WIREGUARD_VPN_PUBLIC_KEY" \
                allowed-ips "$WIREGUARD_ALLOWED_IPS" || die

        ip link set "$WIREGUARD_NAME" netns "$NETNS_NAME" || die

        # Addresses are comma-separated, so to split them.
        tr ',' '\n' <<<"$WIREGUARD_IP_ADDRESSES" |
            xargs -I '{}' \
                ip -n "$NETNS_NAME" address add '{}' dev "$WIREGUARD_NAME" || die

        ip -n "$NETNS_NAME" link set "$WIREGUARD_NAME" up || die
        ip -n "$NETNS_NAME" route add default dev "$WIREGUARD_NAME" || die
        ;;

    down)
        # We need to delete the WireGuard interface. It's initially created in
        # the init network namespace, then moved to the VPN namespace.
        # Depending how well the "up" operation went, it might be in either.
        ip -n "$NETNS_NAME" link delete "$WIREGUARD_NAME" ||
            ip link delete "$WIREGUARD_NAME" || die
        ;;
esac

